<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f0f9ff">
    
    <title>Jasper P3 終極唯一解版</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto+Mono:wght@500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f9ff; touch-action: manipulation; }
        .math-font { font-family: 'Roboto Mono', monospace; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 算草區樣式 */
        .carry-input {
            width: 100%; height: 28px; text-align: center;
            font-size: 0.9rem; font-weight: bold; color: #ef4444;
            background-color: transparent; border: 2px dashed #fda4af;
            border-radius: 4px; outline: none;
        }
        .carry-input:focus { background-color: #fff1f2; border-color: #ef4444; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, memo } = React;
        const TOTAL_QUESTIONS = 10;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(660, now); 
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, now); 
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        };

        const DigitSlot = ({ q, type, row, userInputs, mode, onInput }) => {
            const key = `${type}_${row}`;
            const isBlank = q.blanks.includes(key);
            const value = q.digits[key];
            if (value === 0 && row === 'h' && !isBlank) return <div className="w-10 h-14 md:w-12 md:h-16"></div>;
            if (value === 0 && row === 't' && q.digits[`${type}_h`] === 0 && !isBlank) return <div className="w-10 h-14 md:w-12 md:h-16"></div>;

            if (isBlank) {
                const inputValue = userInputs[key] || '';
                const isCorrect = inputValue === value.toString();
                const isLocked = mode === 'retry' && isCorrect;
                let borderClass = mode === 'retry' && !isLocked ? "border-orange-400 border-4 bg-orange-50 animate-pulse" : (isLocked ? "border-green-500 bg-green-50 text-green-600 border-2" : "border-blue-400 border-2 bg-white");
                return <input type="tel" value={inputValue} readOnly={isLocked} onChange={(e) => onInput(key, e.target.value)} className={`w-10 h-14 md:w-12 md:h-16 text-center text-2xl md:text-3xl font-bold rounded-lg shadow-inner outline-none transition-all math-font ${borderClass}`} />;
            }
            return <div className="w-10 h-14 md:w-12 md:h-16 flex items-center justify-center text-3xl md:text-4xl font-black text-slate-700 math-font">{value}</div>;
        };

        const CarrySlot = () => <div className="flex items-end justify-center pb-1"><input type="tel" className="carry-input math-font" /></div>;

        const QuestionCard = ({ q, index, userInputs, mode, feedback, onInput, onSubmit, startTime }) => (
            <div className="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-200 max-w-lg mx-auto fade-in">
                <div className="flex justify-between items-center mb-6 border-b pb-4">
                    <span className="bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full text-sm font-bold">Q {index + 1} / 10</span>
                </div>
                <div className="flex flex-col items-center">
                    <div className="grid grid-cols-[1.5rem_3rem_3rem_3rem] md:grid-cols-[2rem_3.5rem_3.5rem_3.5rem] gap-y-1 gap-x-1 items-center justify-center">
                        <div></div><DigitSlot q={q} type="n1" row="h" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="n1" row="t" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="n1" row="o" userInputs={userInputs} mode={mode} onInput={onInput} />
                        <div className="text-2xl font-bold text-slate-400 text-center">{q.op1 === '*' ? '×' : q.op1}</div><DigitSlot q={q} type="n2" row="h" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="n2" row="t" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="n2" row="o" userInputs={userInputs} mode={mode} onInput={onInput} />
                        <div></div><CarrySlot /><CarrySlot /><CarrySlot />
                        <div className="col-span-4 h-1 bg-slate-800 rounded-full my-1"></div>
                        <div></div><DigitSlot q={q} type="r1" row="h" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="r1" row="t" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="r1" row="o" userInputs={userInputs} mode={mode} onInput={onInput} />
                        <div className="text-2xl font-bold text-slate-400 text-center">{q.op2 === '*' ? '×' : q.op2}</div><DigitSlot q={q} type="n3" row="h" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="n3" row="t" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="n3" row="o" userInputs={userInputs} mode={mode} onInput={onInput} />
                        <div></div><CarrySlot /><CarrySlot /><CarrySlot />
                        <div className="col-span-4 h-1 bg-slate-800 rounded-full my-1"></div>
                        <div></div><DigitSlot q={q} type="r2" row="h" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="r2" row="t" userInputs={userInputs} mode={mode} onInput={onInput} /><DigitSlot q={q} type="r2" row="o" userInputs={userInputs} mode={mode} onInput={onInput} />
                    </div>
                </div>
                <div className="mt-6 min-h-[3rem]">{feedback && <div className={`p-3 rounded-xl text-center font-bold ${feedback.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}`}>{feedback.msg}</div>}</div>
                {mode === 'normal' && <button onClick={onSubmit} className="w-full bg-indigo-600 text-white py-4 rounded-2xl text-xl font-black mt-4">提交 Check</button>}
            </div>
        );

        const App = () => {
            const [step, setStep] = useState('menu');
            const [qIndex, setQIndex] = useState(0);
            const [questions, setQuestions] = useState([]);
            const [userInputs, setUserInputs] = useState({});
            const [mode, setMode] = useState('normal'); 
            const [feedback, setFeedback] = useState(null);

            const generateQuestions = useCallback(() => {
                let newQs = [];
                for(let i=0; i<TOTAL_QUESTIONS; i++) {
                    let validPuzzle = false;
                    let puzzleData = null;
                    while(!validPuzzle) {
                        // ... (數學式生成邏輯保持 P3 混合運算) ...
                        let n1 = Math.floor(Math.random()*89)+10, op1 = Math.random()>0.5?'+':'-', n2 = Math.floor(Math.random()*89)+10;
                        let r1 = op1==='+'?n1+n2:n1-n2;
                        if(r1<10 || r1>999) continue;
                        let op2 = '*', n3 = Math.floor(Math.random()*8)+2, r2 = r1*n3;
                        if(r2>999) { op2 = '-'; n3 = Math.floor(Math.random()*r1); r2 = r1-n3; }

                        const getD = (n) => ({ h: Math.floor(n/100), t: Math.floor((n%100)/10), o: n%10 });
                        const digits = {
                            'n1_h':getD(n1).h,'n1_t':getD(n1).t,'n1_o':getD(n1).o,'n2_h':getD(n2).h,'n2_t':getD(n2).t,'n2_o':getD(n2).o,'r1_h':getD(r1).h,'r1_t':getD(r1).t,'r1_o':getD(r1).o,
                            'n3_h':getD(n3).h,'n3_t':getD(n3).t,'n3_o':getD(n3).o,'r2_h':getD(r2).h,'r2_t':getD(r2).t,'r2_o':getD(r2).o
                        };

                        // *** 強制唯一解核心邏輯：三重鎖定 ***
                        // 定義「邏輯三元組」：同一列的三個數字
                        const logicTriples = [
                            ['n1_o','n2_o','r1_o'],['n1_t','n2_t','r1_t'],['n1_h','n2_h','r1_h'],
                            ['r1_o','n3_o','r2_o'],['r1_t','n3_t','r2_t'],['r1_h','n3_h','r2_h']
                        ];
                        
                        let currentBlanks = [];
                        let potentialKeys = Object.keys(digits).filter(k => !(k.endsWith('_h') && digits[k]===0)).sort(()=>Math.random()-0.5);
                        
                        for(let key of potentialKeys) {
                            // 檢查：如果加上呢一格，會唔會令任何一個 Triple 入面出現 2 個或以上嘅空格？
                            let wouldBeAmbiguous = logicTriples.some(triple => {
                                const blanksInTriple = triple.filter(tk => [...currentBlanks, key].includes(tk));
                                return blanksInTriple.length >= 2;
                            });
                            if(!wouldBeAmbiguous) currentBlanks.push(key);
                            if(currentBlanks.length >= 4) break;
                        }

                        if(currentBlanks.length >= 2) { validPuzzle = true; puzzleData = { id: i, digits, blanks: currentBlanks, op1, op2 }; }
                    }
                    newQs.push(puzzleData);
                }
                return newQs;
            }, []);

            const startQuiz = () => { setQuestions(generateQuestions()); setQIndex(0); setUserInputs({}); setMode('normal'); setStep('quiz'); };
            const handleInput = (key, val) => { const num = val.slice(-1).replace(/[^0-9]/g, ''); setUserInputs(prev => ({...prev, [key]: num})); if(mode==='retry') { if(num === questions[qIndex].digits[key].toString()) playSound('success'); } };
            const submit = () => {
                const q = questions[qIndex];
                if(q.blanks.every(k => userInputs[k] === q.digits[k].toString())) { playSound('success'); if(qIndex < 9) { setQIndex(qIndex+1); setUserInputs({}); setFeedback(null); } else setStep('menu'); }
                else { playSound('error'); setMode('retry'); setFeedback({type:'error', msg:'有啲位計錯咗，試下訂正！'}); }
            };

            return (
                <div className="min-h-screen p-4 flex items-center justify-center">
                    {step === 'menu' && <button onClick={startQuiz} className="bg-indigo-600 text-white px-12 py-6 rounded-3xl text-3xl font-black">開始挑戰</button>}
                    {step === 'quiz' && <QuestionCard q={questions[qIndex]} index={qIndex} userInputs={userInputs} mode={mode} feedback={feedback} onInput={handleInput} onSubmit={submit} />}
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
